Curso PostGreSQL Completo
Instrutor: Sandro Servino
https://www.linkedin.com/in/sandroservino/?originalSubdomain=pt

-------------------------------------------------------------------------------------------------------------------------------------

No PostgreSQL 17, a estrutura de diretÃ³rios dentro do diretÃ³rio data 
segue um padrÃ£o semelhante ao das versÃµes anteriores, mas pode ter 
algumas mudanÃ§as sutis dependendo das configuraÃ§Ãµes e do sistema 
operacional. O diretÃ³rio data Ã© o local onde o PostgreSQL armazena seus 
arquivos de configuraÃ§Ã£o, logs, e, principalmente, os dados do banco.

Vamos dar uma olhada no diretorio DATA:

C:\Program Files\PostgreSQL\17\data

Estrutura de DiretÃ³rios do PostgreSQL 17 (data)

base/

ContÃ©m os diretÃ³rios e arquivos dos bancos de dados individuais.
Cada banco de dados tem um diretÃ³rio prÃ³prio, cujo nome Ã© o OID do banco.
Dentro de cada diretÃ³rio de banco, os arquivos de tabelas e Ã­ndices 
sÃ£o armazenados.

Oque Ã© OID no PostgreSQL?
OID (Object Identifier) Ã© um identificador numÃ©rico Ãºnico atribuÃ­do 
a objetos do banco de dados, como tabelas, bancos de dados e outras 
entidades. No caso dos bancos de dados, cada um recebe um OID Ãºnico 
no momento da criaÃ§Ã£o.

Como descobrir o OID do banco de dados?
Para saber qual desses diretÃ³rios pertence ao seu banco de dados 
chamado bancox, execute este comando no psql:

SELECT oid, datname FROM pg_database WHERE datname = 'bancox';
SELECT oid, datname FROM pg_database;

** DICA:

Os bancos de dados template0 e template1 sÃ£o bancos especiais 
no PostgreSQL usados como modelos para a criaÃ§Ã£o de novos 
bancos de dados. Eles nÃ£o aparecem no pgAdmin por padrÃ£o porque 
sÃ£o bancos do sistema e nÃ£o devem ser alterados diretamente.

ðŸ“Œ O que Ã© o template1?
O template1 Ã© o modelo padrÃ£o para a criaÃ§Ã£o de novos bancos de dados.

Quando vocÃª executa:
CREATE DATABASE meu_banco;

O PostgreSQL copia todos os objetos do template1 para o novo banco.
VocÃª pode modificar o template1 (por exemplo, adicionando extensÃµes), 
e essas mudanÃ§as serÃ£o replicadas em novos bancos criados a partir dele.

exemplo:
\c template1
CREATE EXTENSION IF NOT EXISTS nome_da_extensao;

Vamos ver isto no futuro.

ðŸ“Œ O que Ã© o template0?
O template0 Ã© um modelo imutÃ¡vel, usado quando vocÃª precisa criar 
um banco de dados "limpo", sem customizaÃ§Ãµes.
Ele nÃ£o pode ser modificado e Ã© usado para restaurar o estado original 
de um banco. Se precisar criar um banco sem customizaÃ§Ãµes do template1, 
use:

CREATE DATABASE meu_banco TEMPLATE template0;

--

global/

o diretÃ³rio global/ armazena informaÃ§Ãµes globais que sÃ£o compartilhadas 
entre todos os bancos de dados da instancia ou do cluster Postgres.

Principais Arquivos no DiretÃ³rio global/

pg_filenode.map:
FunÃ§Ã£o: Este arquivo mapeia os identificadores internos (filenodes)
para os arquivos fÃ­sicos que armazenam as tabelas e Ã­ndices no sistema 
de arquivos.

pg_internal.init:
FunÃ§Ã£o: Utilizado para inicializar a estrutura interna do banco de dados, 
configurando aspectos essenciais para o funcionamento do Postgres.

pg_control:
FunÃ§Ã£o: ContÃ©m informaÃ§Ãµes crÃ­ticas sobre o estado do banco de dados, 
como a versÃ£o do PostgreSQL, o nÃºmero do Ãºltimo checkpoint e detalhes 
sobre os arquivos WAL (Write-Ahead Logging). 
Este arquivo Ã© fundamental para a recuperaÃ§Ã£o do banco de dados apÃ³s 
falhas.

config_exec_params:
FunÃ§Ã£o: Armazena parÃ¢metros de configuraÃ§Ã£o utilizados pelo PostgreSQL 
durante a execuÃ§Ã£o, influenciando o comportamento do sistema em tempo 
de operaÃ§Ã£o.

Esses arquivos sÃ£o essenciais para a operaÃ§Ã£o interna do PostgreSQL 
e devem ser manipulados com cautela. AlteraÃ§Ãµes inadequadas podem 
comprometer a integridade e a estabilidade do banco de dados.

--

pg_wal/

O diretÃ³rio pg_wal/ no PostgreSQL armazena os arquivos de 
Write-Ahead Logging (WAL), que registram todas as operacoes de mudanÃ§as no 
banco de dados antes de serem aplicadas no arquivo final de dados. 
Esses arquivos sÃ£o fundamentais para:

- RecuperaÃ§Ã£o de falhas (permite restaurar o banco em caso de crash).
- ReplicaÃ§Ã£o (sincronizaÃ§Ã£o entre servidores primÃ¡rio e rÃ©plica).
- Point-in-Time Recovery (PITR) (recuperaÃ§Ã£o atÃ© um ponto especÃ­fico no tempo).
- O PostgreSQL mantÃ©m esses arquivos atÃ© que sejam arquivados ou 
  nÃ£o sejam mais necessÃ¡rios.

Antes do PostgreSQL 10, esse diretÃ³rio era chamado de pg_xlog/.

WAL TEM TUDO A VER EM BANCO DE DADOS RELACIONAL COM O CONCEITO ACID:

O conceito ACID no PostgreSQL (e em bancos de dados transacionais em geral)
se refere a quatro propriedades fundamentais para garantir a 
integridade dos dados:

. Atomicidade (A - Atomicity): Uma transaÃ§Ã£o deve ser tudo ou nada. 
Se qualquer parte falhar, todas as alteraÃ§Ãµes sÃ£o revertidas.

. ConsistÃªncia (C - Consistency): O banco deve sempre permanecer 
em um estado vÃ¡lido antes e depois da transaÃ§Ã£o.

. Isolamento (I - Isolation): TransaÃ§Ãµes concorrentes nÃ£o devem interferir 
umas nas outras de maneira indesejada, por exemplo, dois processos
nao podem alterar o mesmo dado no mesmo momento, e o banco de dados
protege atraves de locks, que iremos ver no futuro.

. Durabilidade (D - Durability): ApÃ³s um commit, os dados devem ser 
gravados permanentemente, mesmo em caso de falha do sistema.

Como o WAL garante ACID?
O Write-Ahead Logging (WAL) desempenha um papel crucial para garantir ACID,
como por exemplo:

O PostgreSQL escreve todas as alteraÃ§Ãµes nos files do WAL log antes de 
aplicÃ¡-las nos files de dados do banco de dados. Isso significa que, 
mesmo que ocorra uma falha antes de os dados serem gravados nos arquivos
de dados no disco, as mudanÃ§as podem ser recuperadas ao reiniciar o Postgres,
atravÃ©s da leitura das transacoes completadas que foram registradas 
nos files do WAL Log no disco.

Se uma transaÃ§Ã£o falha no meio do processo, as operaÃ§Ãµes registradas 
no WAL Log sem o commit podem ser desfeitas, garantindo que nenhuma 
mudanÃ§a parcial permaneÃ§a. 

No caso de um crash, o PostgreSQL quando reinicializa lÃª os 
registros do WAL log e reexecuta as transacoes comitadas mas que 
nao tinham sido ainda garantidos nos files de dados no disco ou desfaz 
transaÃ§Ãµes incompletas para restaurar o banco a um estado consistente.

Dessa forma, o WAL log nÃ£o sÃ³ melhora a seguranÃ§a e confiabilidade do 
PostgreSQL, como tambÃ©m viabiliza a replicaÃ§Ã£o e o Point-in-Time 
Recovery (PITR), mas vamos vamos muito sobre isto ainda.

--

pg_commit_ts/

ContÃ©m timestamps de commits, se o recurso estiver habilitado.
Esse recurso continua sendo opcional e depende da configuraÃ§Ã£o 
track_commit_timestamp, mas vamos falar sobre configuracoes de
parametros de start depois.

Para que isso Ã© usado?
- ReplicaÃ§Ã£o lÃ³gica: Ajuda a resolver conflitos em replicaÃ§Ãµes 
  multi-master.
- Monitoramento e auditoria: Permite verificar a ordem dos commits 
  e quando uma transaÃ§Ã£o foi finalizada.

Se track_commit_timestamp estiver desligado (valor padrÃ£o), o diretÃ³rio 
pg_commit_ts/ fica vazio.

Se vocÃª deseja habilitar esse recurso, pode configurar o parÃ¢metro 
track_commit_timestamp no arquivo de configuraÃ§Ã£o postgresql.conf:

track_commit_timestamp = on

--

pg_logical/

O diretÃ³rio pg_logical/ no PostgreSQL armazena informaÃ§Ãµes relacionadas
 Ã  replicaÃ§Ã£o lÃ³gica. Esse recurso permite replicaÃ§Ã£o de dados entre 
diferentes instÃ¢ncias do PostgreSQL, capturando as mudanÃ§as de dados 
(inserÃ§Ãµes, atualizaÃ§Ãµes, exclusÃµes) em tempo real. 
A replicaÃ§Ã£o lÃ³gica Ã© usada em cenÃ¡rios como replicaÃ§Ã£o seletiva de 
tabelas ou replicaÃ§Ã£o entre diferentes versÃµes de PostgreSQL, 
e Ã© comumente utilizada para distribuiÃ§Ã£o de dados ou migraÃ§Ã£o de dados.

--

pg_notify/

Armazena dados sobre notificaÃ§Ãµes assÃ­ncronas (LISTEN/NOTIFY).

O PostgreSQL permite que processos do banco de dados enviem e recebam 
notificaÃ§Ãµes sem precisar verificar constantemente 
as tabelas (evitando polling).

o mecanismo LISTEN/NOTIFY do PostgreSQL tem algumas semelhanÃ§as 
com o Service Broker do SQL Server(servico de mensageria), 
como por exemplo:
âœ… ComunicaÃ§Ã£o assÃ­ncrona: Ambos permitem que processos do banco se 
comuniquem sem precisar consultar tabelas constantemente.
âœ… Eventos internos no banco: Podem ser usados para notificar processos 
sobre mudanÃ§as ou eventos importantes.
âœ… Desempenho melhor que polling: Eliminam a necessidade de consultas 
frequentes para detectar alteraÃ§Ãµes.
âœ… Pode ser usado como parte de um sistema de cache para conexÃµes 
de usuÃ¡rios.

--

pg_replslot/

O diretÃ³rio pg_replslot/ armazena informaÃ§Ãµes relacionadas 
Ã  replicaÃ§Ã£o no PostgreSQL, tanto para replicaÃ§Ã£o fÃ­sica quanto lÃ³gica.

Objetivo:
Guardar registros de mudanÃ§as no banco: Ele garante que os registros 
de alteraÃ§Ãµes feitos no banco de dados sejam mantidos disponÃ­veis 
atÃ© que sejam consumidos por outro sistema ou servidor.

SincronizaÃ§Ã£o entre servidores: Esse diretÃ³rio Ã© utilizado para 
sincronizar dados entre servidores, impedindo que registros importantes 
sejam apagados antes de serem replicados.

Controle de dados replicados: Ele facilita o processo de replicaÃ§Ã£o, 
ajudando a controlar quais dados foram lidos e replicados para outras 
instÃ¢ncias do banco.

Em resumo, a funÃ§Ã£o desse diretÃ³rio Ã© gerenciar a replicaÃ§Ã£o de dados 
para garantir que as informaÃ§Ãµes sejam transmitidas corretamente 
e de maneira eficiente entre servidores.

Mas porque tenho um outro diretorio para replicacao logica?

O PostgreSQL oferece dois tipos de replicaÃ§Ã£o: fÃ­sica e lÃ³gica. 
Embora ambos envolvam a replicaÃ§Ã£o de dados, a replicaÃ§Ã£o lÃ³gica, 
especialmente com a extensÃ£o pg_logical, tem um controle mais detalhado 
e flexÃ­vel sobre quais dados serÃ£o replicados, podendo por exemplo
replicar apenas um determinado banco de dados ou mesmo tabela de 
um banco de dados, enquanto a replicacao fisica, replica de forma
binaria todos os arquivos da instancia postgres e nao permite
selecionar objetos especificos.

pg_logical/ Ã© dedicado a armazenar informaÃ§Ãµes especificas 
sobre a replicaÃ§Ã£o lÃ³gica 
enquanto pg_replslot/ gerencia a replicaÃ§Ã£o de forma mais geral 
(incluindo a replicaÃ§Ã£o fÃ­sica).

--

pg_serial/

ContÃ©m informaÃ§Ãµes sobre transaÃ§Ãµes serializÃ¡veis.

O que sÃ£o transaÃ§Ãµes serializÃ¡veis?
No PostgreSQL ou em qualquer banco de dados relacional sÃ©rio que 
siga o padrao SQL ANSI/ISO de nivel de isolamento, o nÃ­vel de isolamento 
serializÃ¡vel Ã© o mais alto de todos os nÃ­veis de isolamento de transaÃ§Ãµes. 
Ele garante que as transaÃ§Ãµes sejam executadas de forma que o resultado 
final seja o mesmo se as transaÃ§Ãµes fossem realizadas de forma 
sequencial (uma apÃ³s a outra), sem interferÃªncia entre elas, 
mesmo que estejam sendo executadas de forma concorrente.

Quando vÃ¡rias transaÃ§Ãµes estÃ£o ocorrendo simultaneamente, o PostgreSQL 
precisa garantir que nÃ£o haja anomalias como leituras sujas, 
leituras fantasmas ou gravaÃ§Ãµes perdidas. No nÃ­vel serializÃ¡vel, 
ele faz isso verificando e evitando condiÃ§Ãµes onde o resultado de 
transaÃ§Ãµes concorrentes poderia ser inconsistente.

Os quatro nÃ­veis de isolamento de transaÃ§Ãµes estabelecidos 
pela ISO (International Organization for Standardization) sÃ£o:

1. Read Uncommitted (Leitura nÃ£o confirmada)
DescriÃ§Ã£o: Permite que uma transaÃ§Ã£o leia dados que ainda nÃ£o foram 
confirmados por outras transaÃ§Ãµes (tambÃ©m conhecidos como "dirty reads").
Problema: Pode resultar em leituras imprecisas, pois as transaÃ§Ãµes 
podem ler dados que depois podem ser desfeitos com um rollback.

2. Read Committed (Leitura confirmada)
DescriÃ§Ã£o: Garante que uma transaÃ§Ã£o leia apenas dados que foram 
confirmados (committed) por outras transaÃ§Ãµes.
Problema: Pode ocorrer o fenÃ´meno de non-repeatable reads, onde, 
se vocÃª ler um valor em uma transaÃ§Ã£o e depois tentar ler o mesmo 
valor novamente, ele pode ter mudado devido a uma outra 
transaÃ§Ã£o confirmada.

3. Repeatable Read (Leitura repetÃ­vel)
DescriÃ§Ã£o: Garante que, durante toda a transaÃ§Ã£o, os dados lidos nÃ£o 
serÃ£o alterados por outras transaÃ§Ãµes, evitando o problema de 
non-repeatable reads.
Problema: Pode ocorrer phantom reads (leituras fantasmas), 
onde novas linhas podem ser inseridas por outras transaÃ§Ãµes que afetam 
o resultado da sua consulta.

4. Serializable (SerializÃ¡vel)
DescriÃ§Ã£o: Ã‰ o nÃ­vel de isolamento mais alto. Ele garante que o 
comportamento da transaÃ§Ã£o serÃ¡ equivalente a se as transaÃ§Ãµes fossem 
executadas sequencialmente, uma apÃ³s a outra, sem sobreposiÃ§Ã£o.

Garantia: Evita todos os tipos de anomalias, incluindo dirty reads, 
non-repeatable reads e phantom reads. PorÃ©m, pode causar grandes 
bloqueios e diminuir muito a concorrÃªncia e trazer grandes problemas
de performance para o seu ambiente.

PadrÃ£o do PostgreSQL 17
O nÃ­vel de isolamento padrÃ£o no PostgreSQL 17 Ã© o Read Committed.

Isso significa que, por padrÃ£o, o PostgreSQL garantirÃ¡ que as transaÃ§Ãµes 
sÃ³ possam ler dados confirmados por outras transaÃ§Ãµes. 
PorÃ©m, ele permite que os dados lidos possam ser alterados por outras 
transaÃ§Ãµes enquanto a transaÃ§Ã£o corrente estÃ¡ em andamento, 
o que pode resultar em non-repeatable reads.

Se vocÃª quiser usar um nÃ­vel de isolamento mais restrito, 
como Repeatable Read ou Serializable, pode configurar 
isso explicitamente na transaÃ§Ã£o com o comando 
SET TRANSACTION ISOLATION LEVEL, dentro de uma stored procedure
por exemplo que seja critica para o sistema, mas vamos conversar mais
para frente.

--

pg_snapshots/

O diretÃ³rio pg_snapshots/ no PostgreSQL armazena snapshots de transaÃ§Ãµes, 
especialmente Ãºteis para o nÃ­vel de isolamento Repeatable Read e
read commited.

Um snapshot Ã© uma visÃ£o consistente do banco de dados em um determinado 
ponto no tempo. Quando uma transaÃ§Ã£o comeÃ§a, o PostgreSQL tira um 
snapshot para garantir que ela veja os mesmos dados atÃ© seu tÃ©rmino, 
mesmo que outras transaÃ§Ãµes faÃ§am alteraÃ§Ãµes.

OBS: O PostgreSQL, assim como o MySQL (InnoDB) e o Oracle, 
usa MVCC (Multiversion Concurrency Control), permitindo que SELECT 
nÃ£o bloqueie UPDATE/DELETE e vice-versa. Isso melhora a concorrÃªncia e
evita bloqueios desnecessÃ¡rios.

JÃ¡ no SQL Server, o comportamento padrÃ£o Ã© pessimista, onde SELECT 
pode bloquear UPDATE/DELETE e vice-versa. No entanto, esse comportamento 
pode ser alterado ativando o parÃ¢metro READ_COMMITTED_SNAPSHOT de um 
determinado banco de dados, o que faz o SQL Server adotar um mecanismo 
similar ao MVCC.

--

pg_stat/

Armazena estatÃ­sticas detalhadas sobre a atividade da instancia Postgres
e dos bancos de dados hospedados nesta instancia, 
coletadas pelo sistema de monitoramento interno do PostgreSQL.

As estatÃ­sticas sÃ£o informaÃ§Ãµes coletadas pelo PostgreSQL sobre o uso 
do banco de dados, como:

. Leituras e gravaÃ§Ãµes de dados.
. OperaÃ§Ãµes de consulta (SELECT, INSERT, UPDATE, DELETE).
. Uso de Ã­ndices.
. Bloqueios de tabelas e registros.
. Desempenho das transaÃ§Ãµes.

Essas estatÃ­sticas ajudam os administradores de banco de dados (DBAs) 
a entender como o banco de dados estÃ¡ sendo usado e onde hÃ¡ potenciais 
problemas de desempenho.

--

pg_stat_tmp/

Armazena estatÃ­sticas temporÃ¡rias em execuÃ§Ã£o.

Essas estatÃ­sticas sÃ£o dados volÃ¡teis, ou seja, elas nÃ£o sÃ£o persistentes 
e sÃ£o apenas temporÃ¡rias. O conteÃºdo Ã© recriado ao reiniciar o PostgreSQL.

Ele contÃ©m arquivos temporÃ¡rios usados pelo coletor de estatÃ­sticas 
do PostgreSQL. Essas estatÃ­sticas incluem informaÃ§Ãµes sobre:

1ï¸ Uso de tabelas e Ã­ndices
NÃºmero de pÃ¡ginas lidas e escritas.
Quantidade de tuplas (linhas) inseridas, atualizadas e excluÃ­das.

2ï¸ Atividade do Autovacuum
Quantidade de autoanÃ¡lises (autovacuum analyze) realizadas.
EstatÃ­sticas sobre auto-vacuums executados.

3ï¸ Atividade do backend (sessÃµes de usuÃ¡rios)
InformaÃ§Ãµes temporÃ¡rias sobre as conexÃµes e atividades recentes.

4ï¸ NÃºmero de commits e rollbacks
Contagem temporÃ¡ria de transaÃ§Ãµes confirmadas e desfeitas antes 
de serem persistidas.

5ï¸ EstatÃ­sticas de E/S (I/O)
Quantidade de blocos de disco lidos e gravados.

As estatÃ­sticas armazenadas nesse diretÃ³rio sÃ£o Ãºteis para que o 
PostgreSQL possa ajustar o desempenho de consultas em tempo real 
e tomar decisÃµes rÃ¡pidas sobre o uso de recursos (como memÃ³ria e CPU).

DiferenÃ§a entre pg_stat/ e pg_stat_tmp/:

pg_stat/: ContÃ©m estatÃ­sticas mais permanentes e gerais sobre a atividade 
do Postgres.

pg_stat_tmp/ â†’ Armazena estatÃ­sticas temporÃ¡rias, que sÃ£o descartadas 
ao reiniciar o PostgreSQL.

--

pg_subtrans/

O diretÃ³rio pg_subtrans/ no PostgreSQL armazena informaÃ§Ãµes sobre 
subtransaÃ§Ãµes, que sÃ£o transaÃ§Ãµes dentro de outras transaÃ§Ãµes. 
As subtransaÃ§Ãµes sÃ£o usadas para fornecer um controle mais granular 
sobre transaÃ§Ãµes compostas, permitindo que o banco de dados trate 
falhas e reversÃµes de maneira eficiente, sem precisar reverter a 
transaÃ§Ã£o principal inteira.

O que sÃ£o subtransaÃ§Ãµes?
Uma subtransaÃ§Ã£o Ã© uma transaÃ§Ã£o que ocorre dentro de uma transaÃ§Ã£o 
principal. Elas permitem que certas partes de uma transaÃ§Ã£o maior 
possam ser completadas ou revertidas independentemente, sem afetar 
toda a transaÃ§Ã£o. Isso Ã© Ãºtil, por exemplo, quando se quer 
commit (confirmar) parte de uma transaÃ§Ã£o, mas ainda manter a 
possibilidade de rollback (desfazer) outras partes.

--

pg_tblspc/

O diretÃ³rio pg_tblspc/ no PostgreSQL armazena links simbÃ³licos que 
apontam para os diretÃ³rios fÃ­sicos onde o PostgreSQL armazenarÃ¡ os 
arquivos dos tablespaces.

Um tablespace Ã© um container lÃ³gico no PostgreSQL, que possui diretÃ³rios 
fÃ­sicos no disco onde os dados e objetos do banco de dados 
(como tabelas, Ã­ndices, etc.) sÃ£o armazenados. Ele permite a distribuiÃ§Ã£o 
dos dados em diferentes dispositivos de armazenamento. 
Em outras palavras, um tablespace permite que o administrador do banco 
de dados defina onde os arquivos de dados do banco (como tabelas, 
Ã­ndices e outros objetos) serÃ£o fisicamente armazenados, separando-os 
de outros dados ou distribuindo-os por diferentes discos para melhorar 
o desempenho.

Quando um tablespace Ã© criado no PostgreSQL (usando o comando 
CREATE TABLESPACE), vocÃª especifica um caminho de diretÃ³rio no sistema 
de arquivos onde o PostgreSQL deve armazenar os dados. 
O PostgreSQL, entÃ£o, cria um link simbÃ³lico dentro do diretÃ³rio 
pg_tblspc/, apontando para esse diretÃ³rio de dados fÃ­sico.

--

pg_twophase/

ContÃ©m informaÃ§Ãµes sobre transaÃ§Ãµes preparadas em um ambiente 
de two-phase commit(2PC).

O 2PC Ã© um processo geralmente utilizado em ambientes distribuÃ­dos 
(como replicaÃ§Ã£o e clusters), onde vÃ¡rias instÃ¢ncias de banco de dados 
precisam garantir que uma transaÃ§Ã£o seja completada de forma consistente 
em todos os lugares.

O diretÃ³rio pg_twophase/ assegura que as transaÃ§Ãµes possam ser 
completadas corretamente ou revertidas, mesmo apÃ³s falhas ou 
reinicializaÃ§Ãµes do sistema.

--

pg_multixact/

O diretÃ³rio pg_multixact/ no PostgreSQL armazena informaÃ§Ãµes sobre 
mÃºltiplos bloqueios de transaÃ§Ãµes quando mais de uma transaÃ§Ã£o 
precisa bloquear a mesma linha ao mesmo tempo.

No PostgreSQL, quando duas ou mais transaÃ§Ãµes precisam compartilhar 
o bloqueio de uma mesma linha, o banco cria um MultiXact (
ou "transaÃ§Ã£o mÃºltipla").

Esse mecanismo permite que mais de uma transaÃ§Ã£o seja "dona" 
de um bloqueio ao mesmo tempo.

Vamos conversar sobre locks no futuro.

--


log/ (se configurado para armazenar logs no diretÃ³rio data, 
MAS Ã‰ DEFAULT DA INSTALACAO)

ContÃ©m arquivos de log do PostgreSQL, se configurado para armazenar 
logs nesse local.

Sempre que tiver algum problema, como por exemplo o PostgreS nao
da start, verifica o ultimo arquivo de log, abra o conteudo
e procure os erros.

C:\Program Files\PostgreSQL\17\data\log

Por exemplo:
2025-03-16 08:18:16.738 GMT [13224] FATAL:  database "teste" does not exist

--

Arquivos importantes no diretÃ³rio raiz (data/)

- postgresql.conf: Arquivo principal de configuraÃ§Ã£o do PostgreSQL, 
  que Ã© lido pelo servico Postgres quando do start, e por exemplo,
  aloca mais memoria ram do servidor para o Postgres.
- pg_hba.conf: ConfiguraÃ§Ã£o de autenticaÃ§Ã£o (mÃ©todos de conexÃ£o).
- pg_ident.conf: Mapeamento de identidades de usuÃ¡rios.
- PG_VERSION: Arquivo que contÃ©m a versÃ£o do PostgreSQL usada no cluster.

VAMOS DETALHAR MAIS UM POUCO SOBRE ESTES FILES:

1. postgresql.conf â€“ Arquivo Principal de ConfiguraÃ§Ã£o do PostgreSQL

Este Ã© o principal arquivo de configuraÃ§Ã£o do PostgreSQL e controla 
diversos aspectos do funcionamento do Postgres. Ele define desde 
parÃ¢metros bÃ¡sicos, como localizaÃ§Ã£o dos logs, 
atÃ© otimizaÃ§Ãµes de desempenho e comportamento da replicaÃ§Ã£o.

ðŸ“Œ LocalizaÃ§Ã£o:
/var/lib/postgresql/17/data/postgresql.conf (em distribuiÃ§Ãµes Linux)
C:\Program Files\PostgreSQL\17\data\postgresql.conf (em Windows)

ðŸ”§ Principais configuraÃ§Ãµes:

ConfiguraÃ§Ãµes Gerais:

data_directory = '/var/lib/postgresql/17/data' 
â†’ Define onde os dados do PostgreSQL estÃ£o armazenados.

hba_file = '/var/lib/postgresql/17/data/pg_hba.conf'
 â†’ Especifica o caminho do arquivo de autenticaÃ§Ã£o (pg_hba.conf).

ident_file = '/var/lib/postgresql/17/data/pg_ident.conf' 
â†’ Define o caminho do arquivo de mapeamento de identidades 
  (pg_ident.conf).

ConfiguraÃ§Ãµes de Rede e ConexÃ£o:

listen_addresses = 'localhost' 
â†’ Define em quais endereÃ§os IP o PostgreSQL vai aceitar conexoes
(pode ser * para aceitar conexÃµes de qualquer IP).

port = 5432 â†’ Define a porta de escuta do PostgreSQL.

max_connections = 100 â†’ NÃºmero mÃ¡ximo de conexÃµes simultÃ¢neas permitidas.

ConfiguraÃ§Ãµes de MemÃ³ria e Performance:

shared_buffers = 128MB 
â†’ Quantidade de memÃ³ria compartilhada usada pelo PostgreSQL.

work_mem = 4MB â†’ MemÃ³ria usada para operaÃ§Ãµes temporÃ¡rias como 
ordenaÃ§Ãµes e joins.

maintenance_work_mem = 64MB â†’ MemÃ³ria alocada para operaÃ§Ãµes 
de manutenÃ§Ã£o como VACUUM e CREATE INDEX.

ConfiguraÃ§Ã£o de Logs:

logging_collector = on 
â†’ Ativa o coletor de logs.

log_directory = 'pg_log' 
â†’ DiretÃ³rio onde os logs serÃ£o armazenados.

log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' 
â†’ Nome do arquivo de log, incluindo data e hora.

ConfiguraÃ§Ã£o de Autovacuum:

autovacuum = on 
â†’ Habilita a execuÃ§Ã£o automÃ¡tica do processo de limpeza VACUUM.

autovacuum_vacuum_threshold = 50 
â†’ NÃºmero de atualizaÃ§Ãµes/deletes antes do VACUUM ser acionado.

ConfiguraÃ§Ã£o de ReplicaÃ§Ã£o e Backup:

wal_level = replica 
â†’ Define o nÃ­vel de registro do Write-Ahead Logging (WAL).

max_wal_senders = 10 
â†’ NÃºmero mÃ¡ximo de conexÃµes de replicaÃ§Ã£o permitidas.

archive_mode = on 
â†’ Ativa o arquivamento de WAL para backups.

ðŸ“Œ ModificaÃ§Ã£o:
Para alterar qualquer configuraÃ§Ã£o, edite o arquivo e reinicie 
o PostgreSQL.

Essa estrutura pode variar se houver configuraÃ§Ãµes personalizadas, 
como o uso de tablespaces externos 
ou configuraÃ§Ã£o diferente para armazenamento de logs e WALs.

--

2. pg_hba.conf â€“ ConfiguraÃ§Ã£o de AutenticaÃ§Ã£o (MÃ©todos de ConexÃ£o)

Esse arquivo define quais usuÃ¡rios podem acessar o banco de dados, de 
quais endereÃ§os IP e qual mÃ©todo de autenticaÃ§Ã£o serÃ¡ utilizado.

ðŸ“Œ LocalizaÃ§Ã£o:

No windows:
C:\Program Files\PostgreSQL\17\data\pg_hba.conf

No linun:
/var/lib/postgresql/17/data/pg_hba.conf

ðŸ”’ Formato das linhas:
Cada linha segue a estrutura:

# Tipo      Banco       UsuÃ¡rio      EndereÃ§o          MÃ©todo de AutenticaÃ§Ã£o
host        all         xpto         192.168.1.0/24    peer map=mymap 
 		
Tipo: local, host, hostssl, hostnossl
Banco: Nome do banco de dados (all significa todos)
UsuÃ¡rio: Nome do usuÃ¡rio (all significa qualquer usuÃ¡rio)
EndereÃ§o: Pode ser um IP ou um intervalo (exemplo: 192.168.1.100 
          ou 192.168.1.0/24)
MÃ©todo de AutenticaÃ§Ã£o:
  md5 â†’ Solicita senha criptografada.
  scram-sha-256 â†’ AutenticaÃ§Ã£o mais segura que md5.
  trust â†’ Permite acesso sem senha (nÃ£o recomendado).
  peer â†’ Permite autenticaÃ§Ã£o pelo nome do usuÃ¡rio do SO.
  ident â†’ Similar ao peer, mas usa um serviÃ§o externo.

OBS:
"local" is for Unix domain socket connections only

ðŸ“Œ Exemplo de configuraÃ§Ã£o, usando o user conectado no SO, desde
   que o mesmo tenha permissao de acessar banco de dados e os objetos
   no Postgres:

# Permite conexÃµes locais sem senha para o usuÃ¡rio postgres
local       all         postgres                          peer map=mymap

# Permite conexÃµes de qualquer usuÃ¡rio vindo de 192.168.1.0/24 
usando senha MD5
host    all             all             192.168.1.0/24        md5

# Permite conexÃµes remotas apenas para o usuÃ¡rio replicator 
via senha criptografada
host    replication     replicator      10.0.0.5/32           scram-sha-256

ðŸ“Œ ModificaÃ§Ã£o:
ApÃ³s qualquer alteraÃ§Ã£o, Ã© necessÃ¡rio recarregar as configuraÃ§Ãµes com:

pg_ctl reload

Ou:

systemctl reload postgresql

--

3. pg_ident.conf â€“ Mapeamento de Identidades de UsuÃ¡rios

Esse arquivo permite mapear usuÃ¡rios do sistema operacional para usuÃ¡rios 
do PostgreSQL. 
Ele Ã© Ãºtil para autenticaÃ§Ã£o via peer ou ident.

ðŸ“Œ LocalizaÃ§Ã£o:

No windows:
C:\Program Files\PostgreSQL\17\data\pg_ident.conf

No linux:
/var/lib/postgresql/17/data/pg_ident.conf

ðŸ”„ Formato das linhas:

# Put your actual configuration here
# ----------------------------------
# MAPNAME       SYSTEM-USERNAME         PG-USERNAME

exemplo:

# Nome do Mapeamento   UsuÃ¡rio SO      UsuÃ¡rio PostgreSQL
mymap                  sandro         xpto
mymap		       ricardo        xpto2

ðŸ“Œ Como funciona?

Se no pg_hba.conf estiver configurado assim:

local all all peer map=mymap

O PostgreSQL verificarÃ¡ pg_ident.conf e permitirÃ¡ que sandro 
(usuÃ¡rio do sistema) se autentique 
como admin_pg (usuÃ¡rio do PostgreSQL).

ðŸ“Œ ModificaÃ§Ã£o:
ApÃ³s mudanÃ§as, recarregar com:

pg_ctl reload

--

4. PG_VERSION â€“ Arquivo com a VersÃ£o do PostgreSQL

Esse Ã© um arquivo simples que contÃ©m apenas um nÃºmero 
representando a versÃ£o do Postgres instalado.

ðŸ“Œ LocalizaÃ§Ã£o:

No Windows:
C:\Program Files\PostgreSQL\17\data\PG_VERSION

No Linux:
/var/lib/postgresql/17/data/PG_VERSION

ðŸ“Œ ConteÃºdo:

Ele exibirÃ¡ algo como:

17

Isso significa que a versÃ£o do Postgres Ã© a 17.

----------------------------------------------------------------------------------

---------- MUDANDO DE ASSUNTO

DESLIGANDO O SERVIDOR POSTGRESQL DE FORMA SEGURA

A forma mais segura de parar o serviÃ§o PostgreSQL no Windows Ã© utilizando 
o Gerenciador de ServiÃ§os ou os comandos apropriados no terminal. 
Aqui estÃ£o as opÃ§Ãµes detalhadas:

1. Pelo Gerenciador de ServiÃ§os
.Abra o Gerenciador de ServiÃ§os:
Pressione Win + R, digite services.msc e pressione Enter.
Localize o serviÃ§o PostgreSQL:
Procure por um serviÃ§o chamado algo como PostgreSQL - versÃ£o 
(por exemplo, PostgreSQL - 15).
Pare o serviÃ§o:
Clique com o botÃ£o direito no serviÃ§o e selecione Parar.
Aguarde atÃ© que o status do serviÃ§o mude para "Parado".

OBS: EVITE SIMPLESMENTE DAR UM SHUTDOWN NO WINDOWS SERVER OU PIOR A VM. 
ANTES PARE O POSTGRESQL E ASSIM
TERA GARANTIR QUE SEU BANCO DE DADOS ESTARÃ INTEGRO. 
Ã‰ RARO DAR PROBLEMA NO BANCO MESMO COM PARADAS INESPERADAS 
DO WINDOWS OU DO SERVIDOR, MAS MELHOR PREVENIR DO QUE REMEDIAR.

2.Se quiser parar via comando do DOS
Va para o DOS como administrator, com o comando CMD.

OBS: SE FOR PARA O DOS SEM MODO ADMINSTRADOR NAO PODERA
PARAR DEVIDO FALTA DE PRIVILEGIO.

E VA PARA A PASTA ONDE INSTALOU O POSTGRESQL. NO MEU CASO:
CD C:\Program Files\PostgreSQL\17\bin

net stop postgresql-x64-17

PARA VER O STATUS DE UM SERVICO:
sc query postgresql-x64-17

Ou pelo services do windows.

O comando net stop postgresql-x64-17 envia um sinal de parada padrÃ£o 
ao serviÃ§o do PostgreSQL.

Isso significa que:
âœ”ï¸ O PostgreSQL aguarda todas as conexÃµes ativas terminarem.
âœ”ï¸ Nenhuma transaÃ§Ã£o ativa Ã© interrompida abruptamente.
âœ”ï¸ Pode demorar se houver conexÃµes longas.

Aqui estÃ£o OUTROS trÃªs comandos para parar o PostgreSQL, com uma 
explicaÃ§Ã£o rÃ¡pida:

1ï¸ Parada segura (aguarda conexÃµes finalizarem normalmente)

pg_ctl -D "C:\Program Files\PostgreSQL\17\data" stop -m smart

âœ”ï¸ MÃ©todo mais seguro.
âœ”ï¸ Espera as conexÃµes terminarem antes de desligar.

2ï¸ Parada rÃ¡pida (finaliza conexÃµes ativas imediatamente)

pg_ctl -D "C:\Program Files\PostgreSQL\17\data" stop -m fast

âš¡ Finaliza as conexÃµes ativas rapidamente.
âš¡ Mais rÃ¡pido, mas pode causar rollback de transaÃ§Ãµes em andamento.

3ï¸ Parada forÃ§ada (mata os processos sem esperar nada)

pg_ctl -D "C:\Program Files\PostgreSQL\17\data" stop -m immediate

ðŸš¨ Desliga imediatamente, sem esperar conexÃµes finalizarem.
ðŸš¨ Pode exigir recuperaÃ§Ã£o na prÃ³xima inicializaÃ§Ã£o. 
(Use sÃ³ em emergÃªncias, POIS PODE TER ATE PERDA DE DADOS OU 
SEU SERVICO NAO SUBIR A DEPENDER DO QUE ESTAVA RODANDO!)

RESULTADO:
C:\Program Files\PostgreSQL\17\bin>pg_ctl -D "C:\Program Files\PostgreSQL\17\data" stop
waiting for server to shut down.... done
server stopped

SE APAREU ALGUMA TELA DO FIREWALL PEDINDO PERMISSAO A SER DADO PARA 
O SERVICO POSTGRESQL SER INICIADO, PODE PERMITIR.

VEJA SE O SERVICE DO POSTGRESQL EM SERVICES FOI PARADO.
PODE VER VIA COMANDO OU NO SERVICES

pg_ctl -D "C:\Program Files\PostgreSQL\17\data" status

SE VOCE FOR EM SERVICES VAI CONSEGUIR DAR START NOVAMENTE NO SERVICO, OU
RODE O COMANDO ABAIXO COMO ADMINISTRATOR NO DOS:

net start postgresql-x64-17

PARA VER O STATUS DE UM SERVICO:

sc query postgresql-x64-17


----------------------------------------------------------------------------------------------------------
FIM










